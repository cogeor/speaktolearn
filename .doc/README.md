# SpeakToLearn - Documentation

## Project Overview

SpeakToLearn is a minimal Flutter mobile application for language learning through pronunciation practice. Users practice sentences by listening to native audio examples, recording their own attempts, and receiving pronunciation scores.

### Core User Flow

1. **Home Screen** - View a single proposed sentence (from tracked list)
2. **Track sentences** - Toggle sentences to practice
3. **Practice** - Listen to examples (male/female), record attempt, get scored
4. **Progress** - System tracks best scores and prioritizes weak areas

### Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Model naming | `TextSequence` (not "Sentence") | Flexible for phrases, words, dialogues |
| Scoring method | Option A: Device ASR + text similarity | Fast MVP, no server costs, swappable interface |
| State management | Riverpod | Dart-idiomatic, minimal boilerplate |
| Storage | Hive | Fast, simple local DB |
| Audio examples | Pre-generated (Python) | Deterministic, no TTS variability |
| Package size | On-demand download + cache | Small initial install |
| Multi-language | `gloss` map + settings | Not English-centric |

---

## Repository Structure

```
speaktolearn/
├── apps/
│   └── mobile_flutter/          # Flutter application
│       ├── lib/
│       │   ├── app/             # App setup, DI, routing, theme
│       │   ├── core/            # Shared utilities
│       │   └── features/        # Feature modules
│       ├── test/
│       ├── assets/
│       ├── android/
│       └── ios/
│
├── tools/
│   └── sentence_gen/            # Python data generation utility
│       ├── sentence_gen/
│       └── output/
│
├── shared/
│   └── data_schema/             # Shared JSON schemas
│
└── .doc/                        # This documentation
```

---

## Architecture Overview

### Flutter App Architecture

**Feature-first + Clean Architecture + Riverpod**

```
feature/
├── domain/          # Pure Dart: entities, interfaces, use cases
├── data/            # IO: implementations, datasources, mappers
└── presentation/    # Flutter: screens, widgets, controllers
```

**Dependency Direction**: UI → Domain ← Data

### Feature Modules

| Module | Responsibility |
|--------|---------------|
| `text_sequences` | Load dataset, display list |
| `progress` | Track user state (tracked, scores, attempts) |
| `selection` | Ordering/ranking logic for "next" |
| `practice` | Home trainer screen orchestration |
| `recording` | Audio capture, latest recording storage |
| `example_audio` | Play pre-generated audio examples |
| `scoring` | ASR + similarity pronunciation grading |
| `settings` | UI language, target language preferences |

---

## Data Contracts

### Dataset JSON (generated by Python)

```json
{
  "schema_version": "1.0.0",
  "dataset_id": "mandarin_core_v1",
  "language": "zh-CN",
  "generated_at": "2026-02-06T10:00:00Z",
  "items": [
    {
      "id": "ts_000001",
      "text": "我想喝水。",
      "romanization": "wǒ xiǎng hē shuǐ",
      "gloss": {
        "en": "I want to drink water.",
        "de": "Ich möchte Wasser trinken."
      },
      "tokens": ["我", "想", "喝", "水"],
      "tags": ["hsk1", "daily"],
      "difficulty": 1,
      "example_audio": {
        "voices": [
          {"id": "f1", "label": {"en": "Female"}, "uri": "assets://examples/female/ts_000001.opus"},
          {"id": "m1", "label": {"en": "Male"}, "uri": "assets://examples/male/ts_000001.opus"}
        ]
      }
    }
  ]
}
```

### Local Progress (per TextSequence)

- `textSequenceId: String`
- `tracked: bool`
- `bestScore: double`
- `lastAttemptAt: DateTime?`
- `attemptCount: int`

---

## Technology Stack

### Flutter Dependencies

| Category | Package | Purpose |
|----------|---------|---------|
| State/DI | `flutter_riverpod` | State management + dependency injection |
| Routing | `go_router` | Declarative navigation |
| Models | `freezed`, `json_serializable` | Immutable models, JSON parsing |
| Storage | `hive`, `hive_flutter` | Local database |
| Audio Play | `just_audio` | Playback from assets/files/URLs |
| Recording | `record` | Audio capture |
| ASR | `speech_to_text` | On-device speech recognition |
| TTS | `flutter_tts` | Fallback synthesis |
| Permissions | `permission_handler` | Microphone access |
| Files | `path_provider` | File system paths |
| HTTP | `dio` | Audio downloads/caching |

### Python Dependencies

| Package | Purpose |
|---------|---------|
| `pydantic` | Schema validation |
| `typer` | CLI interface |
| `openai` | LLM sentence generation |
| `python-dotenv` | Environment config |

---

## Documentation Index

### Flutter App (`apps/mobile_flutter/`)

- [app/](./flutter/app/README.md) - Application setup
- [core/](./flutter/core/README.md) - Shared utilities
- [features/text_sequences/](./flutter/features/text_sequences/README.md)
- [features/progress/](./flutter/features/progress/README.md)
- [features/selection/](./flutter/features/selection/README.md)
- [features/practice/](./flutter/features/practice/README.md)
- [features/recording/](./flutter/features/recording/README.md)
- [features/example_audio/](./flutter/features/example_audio/README.md)
- [features/scoring/](./flutter/features/scoring/README.md)
- [features/settings/](./flutter/features/settings/README.md)

### Python Tools (`tools/sentence_gen/`)

- [sentence_gen/](./python/sentence_gen/README.md) - Generation utility

### Shared (`shared/`)

- [data_schema/](./shared/data_schema/README.md) - JSON schemas

### Testing

- [Integration Tests](./testing/README.md)

---

## Screens (Minimal UI)

### 1. Home Trainer Screen (`/`)

**Purpose**: Distraction-free practice on one sentence

**Layout**:
```
┌────────────────────────────┐
│ [List]              [Track]│  <- Top bar (small icons)
│                            │
│                            │
│       我想喝水。            │  <- Large centered text (tap to expand)
│                            │
│                            │
│         [ Next ]           │  <- Primary button
└────────────────────────────┘
```

**On tap sentence** - Bottom sheet with:
- Play example (Male / Female)
- Record / Stop
- Replay latest recording
- Score display

### 2. Sequence List Screen (`/list`)

**Purpose**: Browse all sequences, toggle tracking

**Layout**:
```
┌────────────────────────────┐
│ ← Sequences                │
├────────────────────────────┤
│ 我想喝水。        85  [★]  │
│ 你好！            --  [ ]  │
│ 谢谢。            72  [★]  │
│ ...                        │
└────────────────────────────┘
```

---

## Theme (Dark, Black/White)

- Background: `#000000` (pure black)
- Primary text: `#FFFFFF` (white)
- Secondary text: `#FFFFFF` at 60% opacity
- Dividers: `#FFFFFF` at 10-15% opacity
- Primary button: White fill, black text

---

## Scoring Algorithm (Option A)

### Pipeline

1. **Record** user audio
2. **ASR** transcription (Mandarin locale `zh-CN`)
3. **Normalize** both strings:
   - Remove punctuation/whitespace
   - Unify full-width/half-width characters
4. **Compute CER** (Character Error Rate):
   ```
   cer = edit_distance(reference, hypothesis) / len(reference)
   ```
5. **Score**:
   ```
   overall = clamp(100 * (1 - cer), 0, 100)
   ```

### Stored Grade

```dart
class Grade {
  final double overall;      // 0-100
  final String method;       // "asr_cer_v1"
  final String? recognizedText;
  final Map<String, dynamic>? details;  // {"cer": 0.15}
}
```

---

## Next Selection Algorithm

When pressing "Next" on Home, choose from tracked sequences using priority:

```dart
double priority(TextSequenceProgress p) {
  final need = 1 - (p.bestScore / 100);
  final newBonus = p.attemptCount == 0 ? 0.35 : 0.0;
  final hoursSince = DateTime.now().difference(p.lastAttemptAt).inHours;
  final recencyPenalty = exp(-hoursSince / 24) * 0.25;
  return need + newBonus - recencyPenalty;
}
```

- Sort tracked by priority descending
- Random pick from top 10 (reduces repetition feel)

---

## MVP Acceptance Criteria

- [ ] Load dataset JSON from assets
- [ ] Home screen shows proposed tracked sequence
- [ ] Next button selects from tracked using priority
- [ ] Track/untrack toggle works
- [ ] List screen shows all sequences with track toggle
- [ ] Play example audio (male/female)
- [ ] Record user audio
- [ ] Score using ASR + CER
- [ ] Save and display best score
- [ ] Replay latest recording
