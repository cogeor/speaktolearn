#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

if ! command -v dart >/dev/null 2>&1; then
  echo "pre-commit: 'dart' is not available on PATH."
  echo "pre-commit: install Flutter SDK and retry."
  exit 1
fi

staged_dart_files="$(
  git -C "$repo_root" diff --cached --name-only --diff-filter=ACMRTUXB \
    | grep -E '^apps/mobile_flutter/.*\.dart$' || true
)"

if [ -z "$staged_dart_files" ]; then
  exit 0
fi

cd "$repo_root/apps/mobile_flutter"

# Check formatting (don't auto-fix, just verify)
echo "pre-commit: checking Dart formatting..."
if ! dart format --output=none --set-exit-if-changed . 2>/dev/null; then
  echo ""
  echo "pre-commit: Formatting issues found!"
  echo "pre-commit: Run 'dart format .' in apps/mobile_flutter to fix."
  exit 1
fi
echo "pre-commit: Dart formatting OK"

# Run analyzer (fail on warnings, ignore infos)
# Note: Must match .github/workflows/ci.yml analyzer flags
echo "pre-commit: running Flutter analyzer..."
if ! flutter analyze --no-fatal-infos 2>/dev/null; then
  echo ""
  echo "pre-commit: Analyzer found warnings!"
  echo "pre-commit: Fix the issues above before committing."
  exit 1
fi
echo "pre-commit: Analyzer OK"

echo "pre-commit: All checks passed."
