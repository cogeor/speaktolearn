#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

if ! command -v dart >/dev/null 2>&1; then
  echo "pre-commit: 'dart' is not available on PATH."
  echo "pre-commit: install Flutter SDK and retry."
  exit 1
fi

staged_dart_files="$(
  git -C "$repo_root" diff --cached --name-only --diff-filter=ACMRTUXB \
    | grep -E '^apps/mobile_flutter/.*\.dart$' || true
)"

if [ -z "$staged_dart_files" ]; then
  exit 0
fi

cd "$repo_root/apps/mobile_flutter"

echo "pre-commit: formatting staged Dart files..."
while IFS= read -r file; do
  rel_path="${file#apps/mobile_flutter/}"
  dart format --output=none "$rel_path"
  git -C "$repo_root" add "apps/mobile_flutter/$rel_path"
done <<< "$staged_dart_files"

echo "pre-commit: Dart formatting checks passed."
